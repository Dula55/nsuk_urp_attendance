{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3><i class="fas fa-user-check mr-2"></i>URP Student Lecture Attendance</h3>
        </div>
        <div class="card-body">
            <!-- Success Message Container (initially hidden) -->
            <div id="successMessage" class="alert alert-success d-none">
                <span id="successContent"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <!-- Flash Messages Container -->
            <div id="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            
            <form id="attendanceForm" method="POST" action="{{ url_for('submit_attendance') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="mb-3">
                    <label for="name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="mb-3">
                    <label for="matric_no" class="form-label">Matric Number</label>
                    <input type="text" class="form-control" id="matric_no" name="matric_no" required>
                </div>
                <div class="mb-3">
                    <label for="course" class="form-label">Course</label>
                    <input type="text" class="form-control" id="course" name="course" required>
                </div>
                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-success" id="submitBtn">
                        <i class="fas fa-check-circle mr-1"></i> Submit Attendance
                    </button>
                    <div>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-home mr-1"></i> Back to Home
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams(new FormData(form))
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            const successMessage = document.getElementById('successMessage');
            const successContent = document.getElementById('successContent');
            
            successContent.innerHTML = `
                Attendance marked successfully for <strong>${data.record.name}</strong> 
                (${data.record.matric_no}) in <strong>${data.record.course}</strong>.
            `;
            successMessage.classList.remove('d-none');
            
            // Clear form on success
            form.reset();
            
            // Auto-hide success message after 5 seconds
            setTimeout(() => {
                successMessage.style.transition = 'opacity 0.5s ease';
                successMessage.style.opacity = '0';
                setTimeout(() => {
                    successMessage.classList.add('d-none');
                    successMessage.style.opacity = '';
                }, 500);
            }, 5000);
        } else {
            showFlashMessage(data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showFlashMessage('Network error - please try again', 'danger');
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
});

function showFlashMessage(message, category) {
    const flashContainer = document.getElementById('flash-messages');
    const alert = document.createElement('div');
    alert.className = `alert alert-${category} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    flashContainer.prepend(alert);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alert.style.transition = 'opacity 0.5s ease';
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 500);
    }, 5000);
}
</script>
{% endblock %}